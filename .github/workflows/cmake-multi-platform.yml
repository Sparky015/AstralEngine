name: CI Build

on:
  
  push:
    branches: [ "main", "development" ]
  pull_request:
    branches: [ "development" ]

jobs:
  build:
    # The type of runner that the job will run on
    runs-on: ${{ matrix.os }}

    strategy:
      # Ensures that all matrix combinations will be attempted even if one fails
      fail-fast: false
      
      # Defines a matrix of configurations to run the job on
      matrix:
        os: [windows-latest, macos-latest]
        build_type: [Debug, Release]

    steps:
    # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
    - uses: actions/checkout@v4

    - name: Configure CMake
      # Configures CMake to generate the build system
      run: >
        cmake -B ${{ github.workspace }}/build
        -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
        -DCMAKE_CXX_STANDARD=20
        -S ${{ github.workspace }}

    - name: Build
      # Builds the project using the generated build system
      run: cmake --build ${{ github.workspace }}/build --config ${{ matrix.build_type }}

    - name: Test
      # Runs tests only for Debug builds
      if: matrix.build_type == 'Debug'
      working-directory: ${{ github.workspace }}/build
      
      # Executes tests defined by CTest
      run: ctest --config ${{ matrix.build_type }}

    - name: Cache
      uses: actions/cache@v4.2.4
      with:
    # This is the folder containing the compiled libraries to cache.
        path: ${{ github.workspace }}/build/_deps
    
    # This key changes whenever your submodule dependencies change.
        key: ${{ runner.os }}-${{ matrix.build_type }}-deps-${{ hashFiles('**/.gitmodules') }}
    
    # This is a fallback for partial cache matches.
        restore-keys: | 
          ${{ runner.os }}-${{ matrix.build_type }}-deps-
        # The chunk size used to split up large files during upload, in bytes
        #upload-chunk-size: # optional
        # An optional boolean when enabled, allows windows runners to save or restore caches that can be restored or saved respectively on other platforms
        enableCrossOsArchive: false # optional, default is false
        # Fail the workflow if cache entry is not found
        fail-on-cache-miss: false # optional, default is false
        # Check if a cache entry exists for the given input(s) (key, restore-keys) without downloading the cache
        lookup-only: false # optional, default is false
        # Run the post step to save the cache even if another step before fails
        save-always: false # optional, default is false
